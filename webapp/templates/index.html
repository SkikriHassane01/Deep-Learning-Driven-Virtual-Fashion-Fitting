{% extends 'base.html' %}

{% block title %}Virtual Fashion Try-On - Home{% endblock %}

{% block content %}
<!-- Enhanced Hero Section -->
<section class="hero-section section position-relative">
    <div class="container position-relative">
        <div class="row align-items-center">
            <!-- Content Column -->
            <div class="col-lg-6 col-md-7">
                <div class="hero-content">
                    <h1 class="hero-title mb-4">
                        Virtual Fashion Try-On
                    </h1>
                    <p class="hero-subtitle mb-4">
                        Transform your look with AI-powered fashion visualization. Upload your photo and describe the clothing you want to try on!
                    </p>
                    
                    <!-- Quick Action Buttons -->
                    <div class="hero-actions d-flex flex-wrap gap-3 mb-4">
                        <a href="#try-on-section" class="btn btn-primary btn-lg">
                            <i class="bi bi-magic me-2"></i>
                            Try On Now
                        </a>
                        {% if user.is_authenticated %}
                        <a href="{% url 'profile' %}" class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-person-circle me-2"></i>
                            View Profile
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if not ai_available %}
                        <div class="alert alert-warning d-inline-flex align-items-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            AI models are not available. Using fallback mode for demonstration.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Professional Business Model Column -->
            <div class="col-lg-6 col-md-5 d-none d-md-block">
                <div class="hero-image-container">
                    <div class="hero-image-wrapper">
                        <img src="/static/images/hero-man.png" 
                             alt="Handsome Young Man" 
                             class="hero-image">
                        <div class="hero-image-overlay"></div>
                        <div class="floating-elements">
                            <div class="floating-dot dot-1">
                                <i class="bi bi-magic"></i>
                            </div>
                            <div class="floating-dot dot-2">
                                <i class="bi bi-palette"></i>
                            </div>
                            <div class="floating-dot dot-3">
                                <i class="bi bi-stars"></i>
                            </div>
                            <div class="floating-dot dot-4">
                                <i class="bi bi-brush"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced How It Works Section -->
<section class="how-it-works-section section section-light">
    <div class="container">
        <div class="section-header text-center mb-5">
            <h2 class="section-title">How It Works</h2>
            <p class="section-subtitle">Get your perfect virtual try-on in three simple steps</p>
        </div>
        
        <div class="row g-4">
            <div class="col-lg-4 col-md-6">
                <div class="feature-card glass-card">
                    <div class="feature-icon">
                        <i class="bi bi-cloud-upload"></i>
                        <div class="feature-number">1</div>
                    </div>
                    <div class="feature-content">
                        <h4 class="feature-title" style="color: white;">Upload Your Photo</h4>
                        <p class="feature-description" style="color: rgba(255, 255, 255, 0.8);">Choose a clear photo showing your upper body with good lighting for the best results</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6">
                <div class="feature-card glass-card">
                    <div class="feature-icon">
                        <i class="bi bi-chat-text"></i>
                        <div class="feature-number">2</div>
                    </div>
                    <div class="feature-content">
                        <h4 class="feature-title" style="color: white;">Describe Your Style</h4>
                        <p class="feature-description" style="color: rgba(255, 255, 255, 0.8);">Enter a detailed description of your desired clothing, including colors and style preferences</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6">
                <div class="feature-card glass-card">
                    <div class="feature-icon">
                        <i class="bi bi-magic"></i>
                        <div class="feature-number">3</div>
                    </div>
                    <div class="feature-content">
                        <h4 class="feature-title" style="color: white;">Get Amazing Results</h4>
                        <p class="feature-description" style="color: rgba(255, 255, 255, 0.8);">Our AI technology generates your virtual try-on in seconds with stunning accuracy</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!-- Clean Try On Section -->
<section class="try-on-section section" id="try-on-section">
    <div class="container">
        <!-- Section Title -->
        <div class="text-center mb-5">
            <h2 class="section-title">
                <i class="bi bi-magic me-3"></i>
                Try On New Outfit
            </h2>
            <p class="section-subtitle">Ready to see how you look in your dream outfit?</p>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-lg-10">
                {% if user.is_authenticated %}
                    <!-- Simple Clean Progress Display -->
                    <div class="simple-progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-content">
                            <div class="progress-icon">
                                <i class="bi bi-magic"></i>
                            </div>
                            <h3 class="progress-title">Generating Your Virtual Try-On</h3>
                            <p class="progress-subtitle">Please wait while our AI creates your personalized result...</p>
                            
                            <div class="simple-progress-bar">
                                <div class="progress-bar-fill"></div>
                            </div>
                            
                            <p class="progress-message" id="progressMessage">Processing in progress...</p>
                        </div>
                    </div>

                    <!-- Clean Upload Form -->
                    <div class="upload-form-container">
                        <form method="post" action="{% url 'upload' %}" enctype="multipart/form-data" id="uploadForm">
                            {% csrf_token %}
                            
                            <!-- Clean Image Upload -->
                            <div class="form-group mb-4">
                                <label for="image" class="form-label">
                                    <i class="bi bi-camera me-2"></i>
                                    Upload Your Photo
                                </label>
                                <div class="file-upload-wrapper">
                                    <input type="file" class="form-control file-input" id="image" name="image" 
                                           accept="image/*" required>
                                    <div class="file-upload-placeholder">
                                        <i class="bi bi-cloud-upload-fill"></i>
                                        <span>Choose a photo or drag and drop</span>
                                        <p>Or click to browse files</p>
                                    </div>
                                </div>
                                <div class="form-text">
                                    üìÅ Supported formats: JPG, PNG, GIF. For best results, use a clear photo with good lighting.
                                </div>
                            </div>
                            
                            <!-- Simple Style Templates Grid -->
                            <div class="style-templates mb-4">
                                <label class="form-label">
                                    <i class="bi bi-palette me-2"></i>
                                    Quick Style Templates
                                </label>
                                <div class="templates-grid">
                                    <div class="template-card" onclick="useTemplate('elegant red evening dress with flowing fabric and sophisticated silhouette, perfect for formal events')">
                                        <i class="bi bi-gem"></i>
                                        <span>Elegant Dress</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('comfortable blue jeans with white cotton t-shirt for everyday style, casual and relaxed fit')">
                                        <i class="bi bi-person-casual"></i>
                                        <span>Casual Wear</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('professional black business suit with crisp white shirt and tie, corporate executive style')">
                                        <i class="bi bi-briefcase"></i>
                                        <span>Business Suit</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('trendy summer outfit with floral patterns and light breathable fabrics, vibrant colors')">
                                        <i class="bi bi-sun"></i>
                                        <span>Summer Style</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('stylish winter coat with warm layers and fashionable accessories, cozy and chic')">
                                        <i class="bi bi-snow"></i>
                                        <span>Winter Coat</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('athletic wear with moisture-wicking fabric and comfortable fit for active lifestyle')">
                                        <i class="bi bi-lightning"></i>
                                        <span>Athletic Wear</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('vintage retro outfit with classic denim jacket and timeless style elements')">
                                        <i class="bi bi-clock-history"></i>
                                        <span>Vintage Style</span>
                                    </div>
                                    
                                    <div class="template-card" onclick="useTemplate('party outfit with sequins and glamorous evening wear perfect for special occasions')">
                                        <i class="bi bi-stars"></i>
                                        <span>Party Outfit</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Clean Text Description -->
                            <div class="form-group mb-4">
                                <label for="prompt" class="form-label">
                                    <i class="bi bi-chat-text me-2"></i>
                                    Describe Your Desired Clothing
                                </label>
                                <textarea class="form-control" id="prompt" name="prompt" rows="4" 
                                          placeholder="Describe your dream outfit... (e.g., elegant red evening dress, casual blue jeans with white t-shirt, formal black suit with tie)"
                                          required maxlength="500"></textarea>
                                <div class="form-text">
                                    üí° Be specific about colors, style, and type of clothing for the most accurate results.
                                </div>
                            </div>
                            
                            <!-- Clean Submit Button -->
                            <div class="submit-wrapper text-center">
                                <button type="submit" class="btn-generate" id="submitBtn">
                                    <i class="bi bi-magic me-2"></i>
                                    Generate Virtual Try-On
                                </button>
                                <p class="mt-3 submit-note">
                                    ‚ú® Your transformation will be ready in ~2-3 minutes
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
                {% else %}
                    <!-- Clean Authentication Required -->
                    <div class="auth-required-container">
                        <div class="text-center mb-5">
                            <h3 class="auth-title">
                                <i class="bi bi-person-lock me-3"></i>
                                Ready to Transform Your Style?
                            </h3>
                            <p class="auth-subtitle">Sign in or create an account to access our AI-powered virtual try-on experience</p>
                        </div>
                        
                        <div class="auth-options text-center">
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="auth-feature">
                                        <i class="bi bi-upload"></i>
                                        <h5>Upload Your Photo</h5>
                                        <p>Upload your images securely to your personal account</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="auth-feature">
                                        <i class="bi bi-clock-history"></i>
                                        <h5>Save Your Try-Ons</h5>
                                        <p>Access your virtual try-on history anytime from your profile</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="auth-actions">
                                <a href="{% url 'register' %}" class="btn-auth btn-primary me-3">
                                    <i class="bi bi-person-plus me-2"></i>
                                    Create Account
                                </a>
                                <a href="{% url 'login' %}" class="btn-auth btn-secondary">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>
                                    Sign In
                                </a>
                            </div>
                            
                            <div class="mt-4">
                                <div class="privacy-note">
                                    <i class="bi bi-shield-check me-2"></i>
                                    Your privacy is protected. We never share your photos.
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Enhanced Split-Screen Results Display -->
                    <div id="results-display" class="results-container" style="display: none;">
                        <div class="split-screen-results">
                            <div class="text-center mb-4">
                                <h3>
                                    <i class="bi bi-magic"></i>
                                    Your Try-On Result
                                </h3>
                                <p class="text-muted">Drag the slider to compare before and after</p>
                            </div>
                            
                            <!-- Split Screen Comparison -->
                            <div class="comparison-wrapper">
                                <button class="fullscreen-toggle" onclick="toggleFullscreen()">
                                    <i class="bi bi-arrows-fullscreen"></i>
                                </button>
                                
                                <div class="before-after-container" id="comparison-container">
                                    <img id="original-image" class="before-image" alt="Original image" style="display: none;">
                                    <img id="result-image" class="after-image" alt="Try-on result" style="display: none;">
                                    
                                    <div class="comparison-slider" id="comparison-slider">
                                        <div class="slider-handle"></div>
                                    </div>
                                </div>
                                
                                <div class="comparison-labels">
                                    <div class="comparison-label">
                                        <i class="bi bi-person"></i> Original
                                    </div>
                                    <div class="comparison-label">
                                        <i class="bi bi-palette"></i> With Garment
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Processing Statistics -->
                            <div class="results-metadata" id="processing-stats" style="display: none;">
                                <div class="metadata-card">
                                    <span class="metadata-value" id="processing-time">2.3s</span>
                                    <span class="metadata-label">Processing Time</span>
                                </div>
                                <div class="metadata-card">
                                    <span class="metadata-value" id="quality-score">94%</span>
                                    <span class="metadata-label">Quality Score</span>
                                </div>
                                <div class="metadata-card">
                                    <span class="metadata-value" id="fit-accuracy">98%</span>
                                    <span class="metadata-label">Fit Accuracy</span>
                                </div>
                                <div class="metadata-card">
                                    <span class="metadata-value" id="realism-level">High</span>
                                    <span class="metadata-label">Realism Level</span>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="results-actions">
                                <button class="action-button primary" onclick="downloadResult()">
                                    <i class="bi bi-download"></i>
                                    Download HD
                                </button>
                                <button class="action-button" onclick="shareResult()">
                                    <i class="bi bi-share"></i>
                                    Share Result
                                </button>
                                <button class="action-button" onclick="saveToGallery()">
                                    <i class="bi bi-bookmark-plus"></i>
                                    Save to Gallery
                                </button>
                                <button class="action-button" onclick="tryAnother()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    Try Another
                                </button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Recent Try-Ons Section - Only for Authenticated Users -->
{% if user.is_authenticated and recent_results %}
<section class="recent-tryons-section section section-light">
    <div class="container">
        <div class="section-header text-center mb-5">
            <h2 class="section-title">
                <i class="bi bi-clock-history me-3"></i>
                Your Recent Try-Ons
            </h2>
            <p class="section-subtitle">Your latest virtual fashion experiments</p>
        </div>
        
        <div class="row g-4 justify-content-center">
            {% for result in recent_results %}
            <div class="col-lg-4 col-md-6">
                <div class="tryon-card" style="padding: 0; border-radius: 24px; overflow: hidden;">
                    {% if result.result_image %}
                        <div class="tryon-image-wrapper" style="position: relative; height: 250px; overflow: hidden; border-radius: 24px 24px 0 0; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary);">
                            <img src="{{ result.result_image.url }}" alt="Try-on result" 
                                 style="max-width: 100%; max-height: 100%; object-fit: contain; object-position: center; transition: transform 0.4s ease; display: block;">
                            <div class="tryon-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.6) 100%); opacity: 0; transition: opacity 0.4s ease;"></div>
                        </div>
                    {% else %}
                        <div class="tryon-image-placeholder" style="height: 250px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; border-radius: 24px 24px 0 0;">
                            <i class="bi bi-image" style="font-size: 3rem; color: var(--text-muted); opacity: 0.5;"></i>
                        </div>
                    {% endif %}
                    <div class="tryon-content" style="padding: 1.5rem;">
                        <h4 class="tryon-title" style="font-size: 1.2rem; margin-bottom: 0.8rem;">Virtual Try-On Result</h4>
                        <p class="tryon-description" style="margin-bottom: 1.2rem; font-size: 0.9rem;">{{ result.clothing_prompt|truncatechars:80 }}</p>
                        <small style="color: var(--text-muted); display: block; margin-bottom: 1rem;">{{ result.created_at|date:"M d, Y" }}</small>
                        <a href="{% url 'result' result.id %}" class="btn-view" style="width: 100%; text-align: center; padding: 0.75rem 1rem;">
                            <i class="bi bi-eye me-1"></i>
                            <span>View Details</span>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Style Template Functionality
function useTemplate(templateText) {
    const promptTextarea = document.getElementById('prompt');
    if (promptTextarea) {
        promptTextarea.value = templateText;
        promptTextarea.focus();
        
        // Add visual feedback
        promptTextarea.style.transform = 'scale(1.02)';
        promptTextarea.style.boxShadow = '0 0 0 3px rgba(139, 92, 246, 0.3)';
        setTimeout(() => {
            promptTextarea.style.transform = 'scale(1)';
            promptTextarea.style.boxShadow = '';
        }, 200);
    }
}


// Simple form submission with direct progress display
const uploadForm = document.getElementById('uploadForm');
if (uploadForm) {
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const uploadContainer = document.querySelector('.upload-form-container');
        const formData = new FormData(this);
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
        
        // Hide form and show progress immediately
        uploadContainer.style.display = 'none';
        progressContainer.style.display = 'block';
        
        // Start upload and monitoring
        startSimpleUpload(formData);
    });
}

// Simple upload with result monitoring
function startSimpleUpload(formData) {
    fetch("{% url 'upload_async' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Store result ID and start monitoring
            localStorage.setItem('pendingResultId', data.result_id);
            monitorSimpleProgress(data.result_id);
        } else {
            showSimpleError(data.error);
        }
    })
    .catch(error => {
        console.error('Upload failed:', error);
        showSimpleError('Upload failed. Please try again.');
    });
}

// Simple progress monitoring - just check completion
function monitorSimpleProgress(resultId) {
    const progressMessage = document.getElementById('progressMessage');
    
    // Update message
    progressMessage.textContent = 'Your AI-powered try-on is being generated...';
    
    // Simple polling to check when processing is complete
    const checkInterval = setInterval(() => {
        fetch(`/result/${resultId}/`, {
            method: 'GET',
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const statusBadge = doc.querySelector('.badge');
            
            if (statusBadge) {
                const statusText = statusBadge.textContent.trim();
                
                if (statusText.includes('Success') || statusText.includes('Completed')) {
                    // Processing completed
                    clearInterval(checkInterval);
                    localStorage.removeItem('pendingResultId');
                    
                    // Update message and redirect
                    progressMessage.textContent = 'Generation complete! Redirecting...';
                    
                    setTimeout(() => {
                        window.location.reload();
                        setTimeout(() => {
                            window.location.href = `/result/${resultId}/`;
                        }, 100);
                    }, 1000);
                    
                } else if (statusText.includes('Failed')) {
                    // Processing failed
                    clearInterval(checkInterval);
                    localStorage.removeItem('pendingResultId');
                    showSimpleError('Processing failed. Please try again.');
                }
            }
        })
        .catch(error => {
            console.error('Error checking result:', error);
        });
    }, 3000); // Check every 3 seconds
}

// Simple error display
function showSimpleError(message) {
    const progressMessage = document.getElementById('progressMessage');
    if (progressMessage) {
        progressMessage.textContent = `Error: ${message}`;
        progressMessage.style.color = '#ff6b6b';
    }
    
    // Show retry option after error
    setTimeout(() => {
        const progressContainer = document.getElementById('progressContainer');
        const uploadContainer = document.querySelector('.upload-form-container');
        
        if (progressContainer && uploadContainer) {
            progressContainer.style.display = 'none';
            uploadContainer.style.display = 'block';
            
            // Reset form
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-magic me-2"></i>Generate Virtual Try-On';
            }
        }
    }, 3000);
}

function checkSimplePendingResult(resultId) {
    fetch(`/result/${resultId}/`, {
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const statusBadge = doc.querySelector('.badge');
        
        if (statusBadge) {
            const statusText = statusBadge.textContent.trim();
            
            if (statusText.includes('Success') || statusText.includes('Completed')) {
                // Processing completed, redirect immediately
                localStorage.removeItem('pendingResultId');
                console.log('Found completed result, redirecting...');
                window.location.href = `/result/${resultId}/`;
                
            } else if (statusText.includes('Processing')) {
                // Still processing, show progress bar
                console.log('Found processing result, showing progress...');
                showSimpleProgress(resultId);
                
            } else if (statusText.includes('Failed')) {
                // Processing failed, clear and show form
                localStorage.removeItem('pendingResultId');
                ensureFormReady();
            }
        }
    })
    .catch(error => {
        console.error('Error checking pending result:', error);
        localStorage.removeItem('pendingResultId');
        ensureFormReady();
    });
}

function showSimpleProgress(resultId) {
    const progressContainer = document.getElementById('progressContainer');
    const uploadContainer = document.querySelector('.upload-form-container');
    
    if (progressContainer && uploadContainer) {
        // Show progress, hide form
        uploadContainer.style.display = 'none';
        progressContainer.style.display = 'block';
        
        // Start monitoring
        monitorSimpleProgress(resultId);
    }
}

function ensureFormReady() {
    const progressContainer = document.getElementById('progressContainer');
    const uploadContainer = document.querySelector('.upload-form-container');
    const submitBtn = document.getElementById('submitBtn');
    
    if (progressContainer && uploadContainer && submitBtn) {
        // Show form, hide progress
        progressContainer.style.display = 'none';
        uploadContainer.style.display = 'block';
        
        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-magic me-2"></i>Generate Virtual Try-On';
    }
}

// This function is no longer needed - removed for simplicity

function resetUploadForm() {
    // Reset the upload form to allow new uploads
    const uploadForm = document.getElementById('uploadForm');
    const progressContainer = document.getElementById('progressContainer');
    const uploadFormContainer = document.querySelector('.upload-form-container');
    const submitBtn = document.getElementById('submitBtn');
    
    if (uploadForm && progressContainer && uploadFormContainer && submitBtn) {
        // Hide progress container and show upload form
        progressContainer.style.display = 'none';
        uploadFormContainer.style.display = 'block';
        
        // Reset form
        uploadForm.reset();
        
        // Reset submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-magic me-2"></i>Generate Virtual Try-On';
        
        // Reset file upload display
        const filePlaceholder = document.querySelector('.file-upload-placeholder');
        const fileWrapper = document.querySelector('.file-upload-wrapper');
        
        if (filePlaceholder && fileWrapper) {
            filePlaceholder.innerHTML = `
                <i class="bi bi-cloud-upload-fill"></i>
                <span>Choose a photo or drag and drop</span>
                <p>Or click to browse files</p>
            `;
            fileWrapper.style.borderColor = 'var(--glass-border-secondary)';
            fileWrapper.style.background = 'var(--glass-secondary)';
            fileWrapper.style.transform = 'scale(1)';
        }
        
        // Clear any stored result IDs
        localStorage.removeItem('pendingResultId');
        
        console.log('Upload form reset for new upload');
    }
}

// Complex checkResultCompletion function removed - using simple polling instead

// All complex progress functions removed for simple, clean implementation


// EternaCloud-Inspired Scroll Animations and Interactions
document.addEventListener('DOMContentLoaded', function() {
    // Check for pending results - show progress if processing
    const pendingResultId = localStorage.getItem('pendingResultId');
    if (pendingResultId) {
        console.log('Found pending result ID:', pendingResultId);
        checkSimplePendingResult(pendingResultId);
    } else {
        // No pending results, ensure form is ready
        console.log('No pending results, form ready');
        ensureFormReady();
    }
    // Navbar scroll behavior
    const navbar = document.querySelector('.modern-navbar');
    let lastScrollTop = 0;
    let scrollTimer = null;
    
    function handleNavbarScroll() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        if (scrollTop > 50) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
        
        // Navbar stays visible - removed hide on scroll behavior
    }
    
    // Enhanced scroll listener with throttling
    let ticking = false;
    window.addEventListener('scroll', function() {
        if (!ticking) {
            requestAnimationFrame(function() {
                handleNavbarScroll();
                ticking = false;
            });
            ticking = true;
        }
    });
    
    // Parallax effect for hero section
    const heroSection = document.querySelector('.hero-section');
    const hero3dPlaceholder = document.querySelector('.hero-3d-placeholder');
    const floatingDots = document.querySelectorAll('.floating-dot');
    
    function handleParallaxEffects() {
        const scrolled = window.pageYOffset;
        const heroHeight = heroSection.offsetHeight;
        const scrollPercent = scrolled / heroHeight;
        
        if (scrollPercent < 1) {
            // 3D model floating effect
            if (hero3dPlaceholder) {
                const translateY = scrolled * 0.3;
                const rotateX = scrollPercent * 10;
                hero3dPlaceholder.style.transform = `translate(-50%, -50%) translateY(${translateY}px) rotateX(${rotateX}deg)`;
            }
            
            // Enhanced floating dots movement
            floatingDots.forEach((dot, index) => {
                const speed = 0.2 + (index * 0.1);
                const translateY = scrolled * speed;
                const rotate = scrolled * (0.5 + index * 0.2);
                dot.style.transform = `translateY(${translateY}px) rotate(${rotate}deg)`;
            });
        }
    }
    
    // Throttled parallax scroll listener
    let parallaxTicking = false;
    window.addEventListener('scroll', function() {
        if (!parallaxTicking) {
            requestAnimationFrame(function() {
                handleParallaxEffects();
                parallaxTicking = false;
            });
            parallaxTicking = true;
        }
    });
    
    // Circular templates enhanced interactions
    const orbitalTemplates = document.querySelectorAll('.orbital-template');
    const templateOrbit = document.querySelector('.template-orbit');
    let isHovering = false;
    
    orbitalTemplates.forEach((template, index) => {
        template.addEventListener('mouseenter', function() {
            isHovering = true;
            // Pause orbit rotation on hover
            if (templateOrbit) {
                templateOrbit.style.animationPlayState = 'paused';
            }
            
            // Add ripple effect
            const ripple = document.createElement('div');
            ripple.className = 'template-ripple';
            ripple.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: radial-gradient(circle, rgba(139, 92, 246, 0.4) 0%, transparent 70%);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                animation: ripple-expand 0.6s ease-out;
                pointer-events: none;
                z-index: -1;
            `;
            this.appendChild(ripple);
            
            setTimeout(() => {
                if (ripple.parentNode) {
                    ripple.remove();
                }
            }, 600);
        });
        
        template.addEventListener('mouseleave', function() {
            isHovering = false;
            // Resume orbit rotation
            setTimeout(() => {
                if (!isHovering && templateOrbit) {
                    templateOrbit.style.animationPlayState = 'running';
                }
            }, 100);
        });
        
        template.addEventListener('click', function() {
            // Enhanced click animation
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
    
    // Add ripple animation styles
    if (!document.getElementById('ripple-styles')) {
        const style = document.createElement('style');
        style.id = 'ripple-styles';
        style.textContent = `
            @keyframes ripple-expand {
                0% {
                    width: 0;
                    height: 0;
                    opacity: 1;
                }
                100% {
                    width: 200px;
                    height: 200px;
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    }
    // Intersection Observer for scroll animations
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, observerOptions);
    
    // Observe elements for animation
    const animateElements = document.querySelectorAll('.feature-card, .upload-card, .tryon-card, .section-header');
    animateElements.forEach(el => {
        el.classList.add('animate-on-scroll');
        observer.observe(el);
    });
    
    // Enhanced file input with glassmorphism
    const fileInput = document.getElementById('image');
    const fileWrapper = document.querySelector('.file-upload-wrapper');
    const filePlaceholder = document.querySelector('.file-upload-placeholder');
    
    if (fileInput && fileWrapper && filePlaceholder) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Create preview if it's an image
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        filePlaceholder.innerHTML = `
                            <img src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px; margin-bottom: 1rem; object-fit: cover;">
                            <div style="color: var(--accent-tertiary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>${file.name}</span>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                } else {
                    filePlaceholder.innerHTML = `
                        <i class="bi bi-check-circle-fill" style="color: var(--accent-tertiary); font-size: 3rem; margin-bottom: 1rem;"></i>
                        <span style="color: var(--accent-tertiary); font-size: 1.1rem;">${file.name}</span>
                    `;
                }
                
                fileWrapper.style.borderColor = 'var(--glass-border-accent)';
                fileWrapper.style.background = 'var(--glass-success)';
                fileWrapper.style.transform = 'scale(1.01)';
            }
        });
    }
    
    // Enhanced drag and drop with glassmorphism
    if (fileWrapper) {
        fileWrapper.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--glass-border-accent)';
            this.style.background = 'var(--glass-accent)';
            this.style.transform = 'scale(1.02)';
            this.style.boxShadow = 'var(--glass-shadow-lg)';
        });
        
        fileWrapper.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--glass-border-secondary)';
            this.style.background = 'var(--glass-secondary)';
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'var(--glass-shadow-md)';
        });
        
        fileWrapper.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = 'var(--glass-border-secondary)';
            this.style.background = 'var(--glass-secondary)';
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'var(--glass-shadow-md)';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                const event = new Event('change', { bubbles: true });
                fileInput.dispatchEvent(event);
            }
        });
    }
    
    // Enhanced smooth scrolling and micro-interactions
    const links = document.querySelectorAll('a[href^="#"]');
    links.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Add hover effects to interactive elements
    const interactiveElements = document.querySelectorAll('.btn, .card, .nav-link');
    interactiveElements.forEach(el => {
        el.addEventListener('mouseenter', function() {
            this.style.transform = this.style.transform || 'translateY(0)';
            if (!this.style.transform.includes('scale')) {
                this.style.transform += ' scale(1.02)';
            }
        });
        
        el.addEventListener('mouseleave', function() {
            this.style.transform = this.style.transform.replace(' scale(1.02)', '');
        });
    });
    
    // Enhanced hover effects for try-on cards with images
    const tryonCards = document.querySelectorAll('.tryon-card');
    tryonCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            const img = this.querySelector('.tryon-image-wrapper img');
            const overlay = this.querySelector('.tryon-overlay');
            const placeholder = this.querySelector('.tryon-image-placeholder i');
            
            if (img) {
                img.style.transform = 'scale(1.05)';
            }
            if (overlay) {
                overlay.style.opacity = '1';
            }
            if (placeholder) {
                placeholder.style.transform = 'scale(1.1)';
                placeholder.style.color = 'var(--accent-secondary)';
            }
        });
        
        card.addEventListener('mouseleave', function() {
            const img = this.querySelector('.tryon-image-wrapper img');
            const overlay = this.querySelector('.tryon-overlay');
            const placeholder = this.querySelector('.tryon-image-placeholder i');
            
            if (img) {
                img.style.transform = 'scale(1)';
            }
            if (overlay) {
                overlay.style.opacity = '0';
            }
            if (placeholder) {
                placeholder.style.transform = 'scale(1)';
                placeholder.style.color = 'var(--text-muted)';
            }
        });
    });
    
    // Removed parallax effect to fix scrolling issues
    
    // Add ripple effect to buttons including view buttons
    const buttons = document.querySelectorAll('.btn-generate, .btn-primary, .btn-view');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
            ripple.classList.add('ripple');
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });
    });
    
    // Split-Screen Results Display Functionality
    initializeSplitScreenResults();
});

// Split-Screen Results Display Functions
function initializeSplitScreenResults() {
    const slider = document.getElementById('comparison-slider');
    const container = document.getElementById('comparison-container');
    const afterImage = document.querySelector('.after-image');
    
    if (slider && container && afterImage) {
        let isSliding = false;
        
        // Mouse events
        slider.addEventListener('mousedown', startSliding);
        document.addEventListener('mousemove', slide);
        document.addEventListener('mouseup', stopSliding);
        
        // Touch events
        slider.addEventListener('touchstart', startSliding);
        document.addEventListener('touchmove', slide);
        document.addEventListener('touchend', stopSliding);
        
        function startSliding(e) {
            e.preventDefault();
            isSliding = true;
            slider.style.cursor = 'grabbing';
        }
        
        function slide(e) {
            if (!isSliding) return;
            
            const rect = container.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
            
            // Update slider position
            slider.style.left = percentage + '%';
            
            // Update clip path for after image
            afterImage.style.clipPath = `polygon(${percentage}% 0%, 100% 0%, 100% 100%, ${percentage}% 100%)`;
        }
        
        function stopSliding() {
            isSliding = false;
            slider.style.cursor = 'col-resize';
        }
    }
}

function showResults(originalSrc, resultSrc, processingStats = null) {
    const resultsDisplay = document.getElementById('results-display');
    const originalImage = document.getElementById('original-image');
    const resultImage = document.getElementById('result-image');
    const progressContainer = document.getElementById('progressContainer');
    
    if (resultsDisplay && originalImage && resultImage) {
        // Hide progress and show results
        if (progressContainer) {
            progressContainer.style.display = 'none';
        }
        resultsDisplay.style.display = 'block';
        
        // Set image sources
        originalImage.src = originalSrc;
        resultImage.src = resultSrc;
        
        // Show images once loaded
        originalImage.onload = () => {
            originalImage.style.display = 'block';
        };
        
        resultImage.onload = () => {
            resultImage.style.display = 'block';
        };
        
        // Update processing statistics if provided
        if (processingStats) {
            updateProcessingStats(processingStats);
        }
        
        // Initialize split screen functionality
        setTimeout(() => {
            initializeSplitScreenResults();
        }, 100);
        
        // Scroll to results
        resultsDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function updateProcessingStats(stats) {
    const processingStatsEl = document.getElementById('processing-stats');
    if (processingStatsEl && stats) {
        processingStatsEl.style.display = 'grid';
        
        // Update individual stats
        const elements = {
            'processing-time': stats.processingTime || '2.3s',
            'quality-score': stats.qualityScore || '94%',
            'fit-accuracy': stats.fitAccuracy || '98%',
            'realism-level': stats.realismLevel || 'High'
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        });
    }
}

function toggleFullscreen() {
    const container = document.getElementById('comparison-container');
    if (container) {
        if (!document.fullscreenElement) {
            container.requestFullscreen().catch(err => {
                console.log('Fullscreen failed:', err);
            });
        } else {
            document.exitFullscreen();
        }
    }
}

function downloadResult() {
    const resultImage = document.getElementById('result-image');
    if (resultImage && resultImage.src) {
        const link = document.createElement('a');
        link.download = 'virtual-tryon-result.jpg';
        link.href = resultImage.src;
        link.click();
    }
}

function shareResult() {
    // Show social media sharing modal
    const shareModal = createShareModal();
    document.body.appendChild(shareModal);
    
    // Add glassmorphism backdrop
    const backdrop = document.createElement('div');
    backdrop.className = 'glass-modal-overlay';
    backdrop.onclick = () => closeShareModal(shareModal, backdrop);
    document.body.appendChild(backdrop);
    
    // Show modal with animation
    setTimeout(() => {
        shareModal.style.opacity = '1';
        shareModal.style.transform = 'translate(-50%, -50%) scale(1)';
    }, 10);
}

function createShareModal() {
    const modal = document.createElement('div');
    modal.className = 'share-modal';
    modal.style.opacity = '0';
    modal.style.transform = 'translate(-50%, -50%) scale(0.8)';
    modal.style.transition = 'all 0.3s ease';
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.zIndex = '2000';
    
    modal.innerHTML = `
        <h4 style="color: white; margin-bottom: 1.5rem; text-align: center;">
            <i class="bi bi-share me-2"></i>
            Share Your Try-On Result
        </h4>
        <div class="share-options">
            <a href="#" class="share-option" onclick="shareToSocial('facebook')">
                <i class="bi bi-facebook"></i>
                <span>Facebook</span>
            </a>
            <a href="#" class="share-option" onclick="shareToSocial('twitter')">
                <i class="bi bi-twitter"></i>
                <span>Twitter</span>
            </a>
            <a href="#" class="share-option" onclick="shareToSocial('instagram')">
                <i class="bi bi-instagram"></i>
                <span>Instagram</span>
            </a>
            <a href="#" class="share-option" onclick="copyShareLink()">
                <i class="bi bi-link-45deg"></i>
                <span>Copy Link</span>
            </a>
        </div>
        <button onclick="closeShareModal(this.closest('.share-modal'), document.querySelector('.glass-modal-overlay'))" class="glass-btn" style="width: 100%; margin-top: 1rem;">
            Close
        </button>
    `;
    
    return modal;
}

function closeShareModal(modal, backdrop) {
    modal.style.opacity = '0';
    modal.style.transform = 'translate(-50%, -50%) scale(0.8)';
    setTimeout(() => {
        document.body.removeChild(modal);
        document.body.removeChild(backdrop);
    }, 300);
}

function shareToSocial(platform) {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('Check out my virtual try-on result!');
    
    let shareUrl;
    switch(platform) {
        case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            break;
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
            break;
        case 'instagram':
            // Instagram doesn't have URL sharing, copy to clipboard instead
            copyShareLink();
            return;
        default:
            return;
    }
    
    window.open(shareUrl, '_blank', 'width=600,height=400');
}

function copyShareLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        // Show temporary success message
        const toast = document.createElement('div');
        toast.className = 'glass-alert glass-alert-success';
        toast.style.position = 'fixed';
        toast.style.top = '20px';
        toast.style.right = '20px';
        toast.style.zIndex = '3000';
        toast.innerHTML = '<i class="bi bi-check-circle me-2"></i>Link copied to clipboard!';
        
        document.body.appendChild(toast);
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 3000);
    });
}

function saveToGallery() {
    // This would integrate with your backend to save to user's gallery
    const toast = document.createElement('div');
    toast.className = 'glass-alert glass-alert-success';
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '3000';
    toast.innerHTML = '<i class="bi bi-bookmark-plus me-2"></i>Saved to your gallery!';
    
    document.body.appendChild(toast);
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}

function tryAnother() {
    const resultsDisplay = document.getElementById('results-display');
    const uploadCard = document.querySelector('.upload-card');
    
    if (resultsDisplay && uploadCard) {
        resultsDisplay.style.display = 'none';
        uploadCard.style.display = 'block';
        uploadCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Reset form
        const form = document.getElementById('uploadForm');
        if (form) {
            form.reset();
            
            // Reset file input display
            const filePlaceholder = document.querySelector('.file-upload-placeholder');
            const fileWrapper = document.querySelector('.file-upload-wrapper');
            if (filePlaceholder && fileWrapper) {
                filePlaceholder.innerHTML = `
                    <i class="bi bi-cloud-upload-fill" style="color: var(--accent-primary); font-size: 3rem; margin-bottom: 1rem;"></i>
                    <span style="color: white; font-size: 1.1rem; font-weight: 500;">Choose a photo or drag and drop</span>
                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin-top: 0.5rem;">Or click to browse files</p>
                `;
                fileWrapper.style.borderColor = 'var(--glass-border-secondary)';
                fileWrapper.style.background = 'var(--glass-secondary)';
                fileWrapper.style.transform = 'scale(1)';
            }
        }
    }
}

</script>

<style>
/* Simple Clean Progress Bar Styles */
.simple-progress-container {
    background: var(--glass-secondary);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border-secondary);
    border-radius: 24px;
    padding: 3rem 2rem;
    text-align: center;
    box-shadow: var(--shadow-xl);
    animation: fadeInScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-content {
    max-width: 500px;
    margin: 0 auto;
}

.progress-icon {
    width: 80px;
    height: 80px;
    background: var(--gradient-primary);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 2rem;
    animation: pulse 2s infinite;
}

.progress-icon i {
    font-size: 2.5rem;
    color: white;
    filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
}

.progress-title {
    color: white;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 2rem;
}

.progress-subtitle {
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 2.5rem;
    font-size: 1.1rem;
}

.simple-progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin: 2rem 0;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #8b5cf6, #a855f7, #c084fc, #e879f9);
    background-size: 200% 100%;
    border-radius: 4px;
    animation: progressFlow 2s linear infinite;
    width: 100%;
}

.progress-message {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    margin-top: 1.5rem;
    animation: fadeInOut 3s ease-in-out infinite;
}

/* Animations */
@keyframes fadeInScale {
    0% {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

@keyframes progressFlow {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 40px rgba(139, 92, 246, 0.4);
    }
    50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 60px rgba(139, 92, 246, 0.6);
    }
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

/* Additional micro-interaction styles */
.ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.6);
    transform: scale(0);
    animation: ripple-animation 0.6s linear;
    pointer-events: none;
}

@keyframes ripple-animation {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

.animate-in {
    opacity: 1 !important;
    transform: translateY(0) !important;
}

/* Smooth transitions for all elements */
* {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Enhanced hover states */
.card:hover {
    will-change: transform;
}

.btn:hover {
    will-change: transform, box-shadow;
}

/* Performance optimizations */
.hero-section,
.feature-card,
.upload-card,
.tryon-card {
    will-change: transform;
}
</style>
{% endblock %}