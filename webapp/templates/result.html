{% extends 'base.html' %}

{% block title %}Try-On Result - Virtual Fashion Try-On{% endblock %}

{% block content %}
<!-- Result Header Section -->
<section class="hero-section section" style="padding: 4rem 0 3rem;">
    <div class="floating-fashion-elements">
        <div class="floating-element"><i class="bi bi-stars"></i></div>
        <div class="floating-element"><i class="bi bi-palette"></i></div>
        <div class="floating-element"><i class="bi bi-magic"></i></div>
        <div class="floating-element"><i class="bi bi-brush"></i></div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="hero-title">Your Virtual Try-On Result</h1>
                <p class="hero-subtitle">See how your AI-generated outfit looks on you</p>
            </div>
        </div>
    </div>
</section>

<!-- Result Display Section -->
<section class="try-on-section section section-light" style="padding: 4rem 0;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="result-card">
                    <div class="card-header">
                        <h4>Virtual Try-On Result</h4>
                        <span class="badge {% if result.processing_status == 'completed' %}bg-success{% elif result.processing_status == 'processing' %}bg-warning{% else %}bg-danger{% endif %}">
                            {% if result.processing_status == 'completed' %}
                                Completed
                            {% elif result.processing_status == 'processing' %}
                                Processing
                            {% else %}
                                Failed
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="result-image-wrapper">
                                    <img src="{{ result.original_image.url }}" 
                                         alt="Original image" 
                                         class="img-fluid rounded">
                                    <p class="image-caption">Original Image</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="result-image-wrapper">
                                    {% if result.result_image %}
                                        <img src="{{ result.result_image.url }}" 
                                             alt="Try-on result" 
                                             class="img-fluid rounded">
                                        <p class="image-caption">AI-Generated Result</p>
                                    {% elif result.processing_status == 'processing' %}
                                        <div class="processing-placeholder">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-3">Processing your request...</p>
                                            <p class="text-muted small">This may take up to 30-60 seconds</p>
                                        </div>
                                    {% else %}
                                        <div class="failed-placeholder">
                                            <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                            <p class="mt-3">Processing failed</p>
                                            <p class="text-muted small">Please try again with a different image</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="result-details mt-4">
                            <h5>Outfit Description</h5>
                            <p>{{ result.clothing_prompt }}</p>
                            
                            <div class="mt-4 d-flex gap-2 flex-wrap">
                                {% if result.result_image %}
                                    <a href="{{ result.result_image.url }}" download class="btn btn-outline-primary">
                                        <i class="bi bi-download me-2"></i>Download Result
                                    </a>
                                {% endif %}
                                <a href="{% url 'generate' %}" class="btn btn-primary">
                                    <i class="bi bi-magic me-2"></i>Create Another Try-On
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Optimized result page script
document.addEventListener('DOMContentLoaded', function() {
    // Check if we need to refresh for processing status
    const processingStatus = "{{ result.processing_status }}";
    if (processingStatus === "processing") {
        setTimeout(checkProcessingStatus, 5000);
    }
    
    // Simple page entrance animation
    const mainContent = document.querySelector('main');
    if (mainContent) {
        mainContent.style.opacity = '0';
        mainContent.style.transform = 'translateY(20px)';
        mainContent.style.transition = 'all 0.6s ease';
        
        setTimeout(() => {
            mainContent.style.opacity = '1';
            mainContent.style.transform = 'translateY(0)';
        }, 100);
    }
});

// Check processing status without full page reload
function checkProcessingStatus() {
    // Use fetch to check status
    fetch(window.location.href, {
        headers: {'X-Requested-With': 'XMLHttpRequest'}
    })
    .then(response => response.text())
    .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Check if processing is complete
        const statusBadge = doc.querySelector('.badge');
        const resultImage = doc.querySelector('img[alt="Try-on result"]');
        
        if (statusBadge && 
            (statusBadge.textContent.trim() === "Completed" || 
             statusBadge.classList.contains('bg-success')) ||
            resultImage) {
            // Processing is complete, reload page
            window.location.reload();
        } else if (statusBadge && statusBadge.textContent.trim() === "Failed") {
            // Processing failed, reload page
            window.location.reload();
        } else {
            // Still processing, check again in 5 seconds
            setTimeout(checkProcessingStatus, 5000);
        }
    })
    .catch(error => {
        console.error('Error checking processing status:', error);
        // Try again in 10 seconds even if there was an error
        setTimeout(checkProcessingStatus, 10000);
    });
}
</script>

<style>
/* Optimized result page styles */
.result-card {
    background: var(--glass-secondary);
    backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border-secondary);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    transition: all 0.3s ease;
}

.result-card:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-5px);
}

.result-card .card-header {
    background: var(--glass-primary);
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--glass-border-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.result-card .card-body {
    padding: 2rem;
}

.result-image-wrapper {
    position: relative;
    margin-bottom: 1.5rem;
    text-align: center;
    border-radius: 16px;
    overflow: hidden;
    background: var(--glass-primary);
    padding: 1rem;
    height: 350px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.result-image-wrapper img {
    max-height: 280px;
    width: auto;
    object-fit: contain;
    border-radius: 12px;
    transition: transform 0.3s ease;
}

.result-image-wrapper:hover img {
    transform: scale(1.03);
}

.image-caption {
    margin-top: 1rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.processing-placeholder, 
.failed-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 2rem;
}

.processing-placeholder .spinner-border {
    width: 3rem;
    height: 3rem;
    color: var(--accent-primary);
}

.failed-placeholder i {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.badge {
    font-size: 0.8rem;
    padding: 0.5rem 1rem;
    border-radius: 50px;
}
</style>
{% endblock %}